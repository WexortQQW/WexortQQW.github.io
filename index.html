<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Форма заказа запчастей</title>
  <style>
    /* RESET */
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0}
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background:#f3f6f9;
      color:#0b1b2b;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex; align-items:flex-start; justify-content:center; padding:24px;
    }

    /* NARROW CARD LAYOUT (visual from your last design) */
    main{ width:100%; max-width:380px; margin:0 auto; }
    .card{ background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 10px 30px rgba(2,6,23,0.06); border:1px solid rgba(11,27,43,0.06); }

    .header{ background: linear-gradient(180deg,#17334f 0%, #0f2a44 100%); color:#fff; padding:14px 16px; font-weight:700; font-size:15px; text-align:center; }
    .content{ padding:18px; }

    label{ display:block; margin-bottom:8px; font-size:13px; color:#344154; font-weight:600; }
    .field{ margin-bottom:12px; }
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], textarea {
      width:100%; padding:12px 14px; border-radius:10px; border:1px solid rgba(22,38,58,0.06); background:#fbfdff;
      font-size:14px; color:#061427; box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); transition:box-shadow .12s, border-color .12s, transform .06s; outline:none;
    }
    textarea{ min-height:110px; resize:vertical; }
    input:focus, textarea:focus{
      border-color:#3aa0ff; box-shadow:0 10px 30px rgba(51,153,255,0.08); transform:translateY(-1px); background:#fff;
    }
    ::placeholder{ color:#95a3b5; }
    .small-hint{ font-size:12px; color:#7b8a99; margin-top:6px; }
    .error{ color:#c23b3b; font-size:13px; margin-top:6px; display:none; }

    .consent{ display:flex; gap:10px; align-items:flex-start; font-size:13px; color:#4b5b6b; margin-top:8px; }
    .consent input[type="checkbox"]{ width:18px; height:18px; margin-top:3px; accent-color:#0f6ee6; }

    .actions{ padding:18px 18px 20px; }
    .submit-btn{
      width:100%; padding:12px 14px; border-radius:8px; border:none;
      background:linear-gradient(180deg,#2a9df4,#0f6ee6); color:#fff; font-weight:700; font-size:15px; box-shadow:0 8px 22px rgba(15,110,230,0.18); cursor:pointer;
    }
    .submit-btn[disabled]{ opacity:0.6; cursor:not-allowed; box-shadow:none; }
    .spinner{ width:16px; height:16px; border-radius:50%; border:3px solid rgba(255,255,255,0.35); border-top-color:#fff; animation:spin .85s linear infinite; display:inline-block; vertical-align:middle; }
    @keyframes spin{ to{ transform:rotate(360deg) } }

    .success-banner{ display:none; margin-top:12px; background:linear-gradient(180deg,#e8f9f1,#dff6ea); border-radius:8px; border:1px solid rgba(22,153,120,0.12); padding:12px; color:#0a4f34; font-weight:600; box-shadow:0 6px 18px rgba(4,25,15,0.02); }

    /* modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:9999; padding:18px; }
    .modal[aria-hidden="false"]{ display:flex }
    .modal-card{ width:100%; max-width:520px; background:#0f2b46; color:#fff; border-radius:10px; padding:18px; box-shadow:0 30px 80px rgba(2,6,23,0.5); position:relative; overflow:hidden; }
    .modal-card .body{ background:#fff; color:#061427; padding:18px; border-radius:8px; }
    .modal-card h3{ margin:0 0 6px; color:#061427 }
    .modal-card p{ margin:6px 0; color:#475569 }

    .modal-actions{ display:flex; gap:12px; margin-top:10px; justify-content:center; flex-wrap:wrap; }
    .modal-actions button{ min-width:120px; padding:10px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }
    #copyBtn{ background:linear-gradient(90deg,#00c7a8, #2dd0ff); color:#04121a }
    #downloadPdfBtn{ background:#eef2f6; color:#072036; }
    #closeBtn{ background:linear-gradient(180deg,#1677d1,#0f5fb0); color:#fff }

    .qr-large { width:260px; height:260px; border-radius:10px; background:#f7fafb; display:flex; align-items:center; justify-content:center; padding:12px; overflow:hidden; margin:12px auto 0; }
    .qr-large img{ display:block; width:100%; height:100%; object-fit:contain; border-radius:6px; }

    @media (max-width:420px){
      main{ padding:0 8px; max-width:360px; }
      .modal-card{ padding:12px; }
      .qr-large{ width:200px; height:200px; }
    }
    /* small link style within consent text */
    .consent a { color:#0f6ee6; text-decoration:underline; }
  </style>
</head>
<body>
  <main>
    <div class="card" role="region" aria-label="Форма заказа">
      <div class="header">Заполните форму для быстрого поиска деталей</div>

      <div class="content">
        <form id="orderForm" method="POST" target="hidden_iframe"
              action="https://script.google.com/macros/s/AKfycby7lHiick8xcyXC61bTxbji2jl6keEuU6ZhCNzY8_POl1Gim7nYrn-GBUxanaifQUdnIg/exec" autocomplete="on" novalidate>

          <div class="field">
            <label for="name">ФИО *</label>
            <input id="name" name="name" type="text" placeholder="Иванов Иван" required aria-required="true" aria-describedby="nameError">
            <div class="small-hint">Имя и фамилия кириллицей, минимум 2 слова.</div>
            <div id="nameError" class="error" role="alert" aria-live="polite">Введите корректное ФИО (кириллица, 2 слова, без нецензурных слов).</div>
          </div>

          <div class="field">
            <label for="phone">Телефон *</label>
            <input id="phone" name="phone" type="tel" placeholder="+7 (XXX) XXX-XX-XX" required aria-required="true" aria-describedby="phoneError">
            <div id="phoneError" class="error" role="alert" aria-live="polite">Введите корректный телефон.</div>
          </div>

          <div class="field">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" placeholder="example@mail.com" aria-describedby="emailError">
            <div id="emailError" class="error" role="alert" aria-live="polite">Некорректный email.</div>
          </div>

          <div class="field">
            <label for="vin">VIN-код автомобиля *</label>
            <input id="vin" name="vin" type="text" placeholder="Введите 17-значный VIN-код" required aria-required="true" aria-describedby="vinError">
            <div class="small-hint">VIN из 17 символов (без I, O, Q)</div>
            <div id="vinError" class="error" role="alert" aria-live="polite">Некорректный VIN.</div>
          </div>

          <div class="field">
            <label for="model">Модель</label>
            <input id="model" name="model" type="text" placeholder="Например: Ford Focus">
          </div>

          <div class="field">
            <label for="year">Год выпуска</label>
            <input id="year" name="year" type="number" min="1900" max="2099" placeholder="2020">
          </div>

          <div class="field">
            <label for="partName">Название детали / Описание *</label>
            <input id="partName" name="partName" type="text" placeholder="Амортизатор, тормозной диск..." required aria-required="true" aria-describedby="partError">
            <div id="partError" class="error" role="alert" aria-live="polite">Укажите название детали.</div>
          </div>

          <div class="field">
            <label for="article">Артикул (если есть)</label>
            <input id="article" name="article" type="text" placeholder="12345-AB">
          </div>

          <div class="field">
            <label for="qty">Количество *</label>
            <input id="qty" name="qty" type="number" min="1" value="1" required aria-required="true">
          </div>

          <div class="field">
            <label for="comment">Комментарий</label>
            <textarea id="comment" name="comment" rows="3" placeholder="Доп. информация"></textarea>
          </div>

          <div class="field consent">
            <!-- сделал чекбокс обязательным и связал с ошибкой через aria-describedby -->
            <input id="consentCheckbox" type="checkbox" name="consent" required aria-required="true" aria-describedby="consentError">
            <div style="font-size:13px;color:#4b5b6b;line-height:1.35;">
              Нажимая «Отправить заявку», я подтверждаю, что ознакомлен(а) и принимаю
              <a href="user_agreement.html" target="_blank" rel="noopener noreferrer">Пользовательское соглашение</a>
              и
              <a href="politica_confed.html" target="_blank" rel="noopener noreferrer">Политику конфиденциальности</a>.
            </div>
          </div>
          <div id="consentError" class="error" role="alert" aria-live="polite">Для отправки формы необходимо ваше согласие.</div>

          <!-- hidden ids -->
          <input type="hidden" name="orderId" id="orderId">
          <input type="hidden" name="personalId" id="personalId">

          <div class="actions">
            <button id="submitBtn" class="submit-btn" type="submit"><span id="btnText">Отправить заявку</span></button>

            <div id="successBanner" class="success-banner" role="status" aria-live="polite">
              Заявка успешно отправлена! Мы свяжемся с вами в ближайшее время.
            </div>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- hidden iframe for POST -->
  <iframe name="hidden_iframe" id="hidden_iframe" style="display:none"></iframe>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card" role="document">
      <div class="body">
        <h3 id="modalTitle">Заявка принята</h3>
        <p id="modalMsg">Спасибо, ваша заявка отправлена.</p>

        <p><strong>Номер заказа:</strong> <span id="orderIdDisplay">—</span></p>
        <p><strong>Персональный ID:</strong> <span id="personalIdDisplay">—</span></p>

        <div class="modal-actions">
          <button id="copyBtn" type="button">Копировать оба</button>
          <button id="downloadPdfBtn" type="button">Скачать PDF</button>
          <button id="closeBtn" type="button">Закрыть</button>
        </div>

        <div class="qr-large" id="qrContainer" title="QR-код заказа" aria-hidden="false"></div>
      </div>
    </div>
  </div>

  <script>
  /* Полный JS: валидация, маска, profanity, autosave, iframe submit + fallback, modal + QR fallback, printable
     + генератор коротких Order ID (формат: Буква-4цифры, например "З-2431")
  */
  document.addEventListener('DOMContentLoaded', () => {
    // Elements
    const form = document.getElementById('orderForm');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const iframe = document.getElementById('hidden_iframe');
    const modal = document.getElementById('modal');
    const orderIdInput = document.getElementById('orderId');
    const personalIdInput = document.getElementById('personalId');

    const nameEl = document.getElementById('name');
    const phoneEl = document.getElementById('phone');
    const emailEl = document.getElementById('email');
    const vinEl = document.getElementById('vin');
    const modelEl = document.getElementById('model');
    const yearEl = document.getElementById('year');
    const partEl = document.getElementById('partName');
    const articleEl = document.getElementById('article');
    const qtyEl = document.getElementById('qty');
    const commentEl = document.getElementById('comment');
    const consentEl = document.getElementById('consentCheckbox');

    const nameError = document.getElementById('nameError');
    const phoneError = document.getElementById('phoneError');
    const emailError = document.getElementById('emailError');
    const vinError = document.getElementById('vinError');
    const partError = document.getElementById('partError');
    const consentError = document.getElementById('consentError');
    const successBanner = document.getElementById('successBanner');

    const modalTitle = document.getElementById('modalTitle');
    const modalMsg = document.getElementById('modalMsg');
    const orderIdDisplay = document.getElementById('orderIdDisplay');
    const personalIdDisplay = document.getElementById('personalIdDisplay');
    const copyBtn = document.getElementById('copyBtn');
    const closeBtn = document.getElementById('closeBtn');
    const qrContainer = document.getElementById('qrContainer');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    // Profanity list (can be extended)
    const profanity = ['хуй','бляд','сука','пизд','еба'];

    // Helpers
    function showError(node, text){
      if (!node) return;
      node.textContent = text || '';
      node.style.display = text ? 'block' : 'none';
    }

    // Name validation: Cyrillic + at least 2 words + profanity check + reject plain Latin gibberish
    function isLikelyLatinGibberish(s){
      if (!s) return false;
      const hasLatin = /[A-Za-z]/.test(s);
      const hasCyr = /[А-Яа-яЁё]/.test(s);
      if (hasLatin && !hasCyr) return true;
      const letters = s.replace(/[^A-Za-z]/g,'');
      if (letters.length >= 4 && (letters.length / s.replace(/[^A-Za-zА-Яа-яЁё]/g,'').length) > 0.6 && hasLatin) return true;
      return false;
    }
    function validateName() {
      const v = nameEl.value.trim();
      if (!v) return {ok:false, msg:'Поле обязательно'};
      const cyrillicOnly = /^[А-ЯЁа-яё\s\-]+$/u.test(v);
      if (!cyrillicOnly) return {ok:false, msg:'ФИО должно быть кириллицей, без латиницы/цифр.'};
      const parts = v.split(/\s+/).filter(Boolean);
      if (parts.length < 2) return {ok:false, msg:'Укажите как минимум фамилию и имя.'};
      const low = v.toLowerCase();
      for (const p of profanity) if (low.includes(p)) return {ok:false, msg:'Поле содержит недопустимые слова.'};
      return {ok:true};
    }

    // Phone handling
    function formatPhone(value){
      const d = (value || '').replace(/\D/g,'');
      let digits = d;
      if (digits.startsWith('8')) digits = '7' + digits.slice(1);
      const p = digits.replace(/^7/,'');

      let out = '+7';
      if (p.length > 0) out += ' (';
      if (p.length <= 3) out += p;
      else out += p.slice(0,3) + ') ';
      if (p.length > 3) {
        if (p.length <=6) out += p.slice(3);
        else out += p.slice(3,6) + '-';
      }
      if (p.length > 6) {
        if (p.length <=8) out += p.slice(6);
        else out += p.slice(6,8) + '-';
      }
      if (p.length > 8) out += p.slice(8,10);
      return out.trim();
    }
    function validatePhone(){
      const digits = (phoneEl.value||'').replace(/\D/g,'');
      if (digits.length === 11 && digits.startsWith('7')) return {ok:true};
      if (digits.length === 10) return {ok:true};
      return {ok:false, msg:'Введите корректный телефон (+7 и 10 цифр).'};
    }

    // Email
    function validateEmail(){
      const v = (emailEl.value||'').trim();
      if (!v) return {ok:true};
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(v) ? {ok:true} : {ok:false, msg:'Некорректный email.'};
    }

    // VIN (17 chars, no I/O/Q)
    function validateVIN(){
      const v = (vinEl.value||'').trim().toUpperCase();
      if (!v) return {ok:false, msg:'VIN обязателен'};
      if (v.length !== 17) return {ok:false, msg:'VIN должен содержать ровно 17 символов.'};
      if (/[IOQ]/.test(v)) return {ok:false, msg:'VIN не должен содержать буквы I, O, Q.'};
      if (!/^[A-Z0-9]+$/.test(v)) return {ok:false, msg:'VIN может содержать только латинские буквы и цифры.'};
      return {ok:true};
    }

    // Part
    function validatePart(){
      const v = (partEl.value||'').trim();
      return v ? {ok:true} : {ok:false, msg:'Укажите название детали.'};
    }

    // Autosave draft
    let saveTimer = null;
    function autosave(){
      const data = {
        name: nameEl.value||'',
        phone: phoneEl.value||'',
        email: emailEl.value||'',
        vin: vinEl.value||'',
        model: modelEl.value||'',
        year: yearEl.value||'',
        partName: partEl.value||'',
        article: articleEl.value||'',
        qty: qtyEl.value||'1',
        comment: commentEl.value||'',
        consent: consentEl.checked||false
      };
      try { localStorage.setItem('orderFormDraft', JSON.stringify(data)); } catch(e){}
    }
    function scheduleAutosave(){
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(autosave, 600);
    }
    function loadDraftIfAny(){
      try {
        const raw = localStorage.getItem('orderFormDraft');
        if (!raw) return;
        const data = JSON.parse(raw);
        if (data.name) nameEl.value = data.name;
        if (data.phone) phoneEl.value = data.phone;
        if (data.email) emailEl.value = data.email;
        if (data.vin) vinEl.value = data.vin;
        if (data.model) modelEl.value = data.model;
        if (data.year) yearEl.value = data.year;
        if (data.partName) partEl.value = data.partName;
        if (data.article) articleEl.value = data.article;
        if (data.qty) qtyEl.value = data.qty;
        if (data.comment) commentEl.value = data.comment;
        if (data.consent) consentEl.checked = !!data.consent;
      } catch(e){}
    }

    // ---------- short order id generator (e.g. "З-2431") ----------
    function getCyrillicAlphabet() {
      return 'АБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЫЭЮЯ'.split('');
    }

    function readGeneratedIds() {
      try {
        const raw = localStorage.getItem('generatedOrderIds');
        return raw ? JSON.parse(raw) : [];
      } catch(e) {
        return [];
      }
    }
    function saveGeneratedId(id) {
      try {
        const arr = readGeneratedIds();
        arr.push(id);
        if (arr.length > 2000) arr.splice(0, arr.length - 2000);
        localStorage.setItem('generatedOrderIds', JSON.stringify(arr));
      } catch(e){}
    }

    function generateShortOrderId() {
      const letters = getCyrillicAlphabet();
      const used = new Set(readGeneratedIds());
      let attempts = 0;
      while (attempts < 50) {
        const letter = letters[Math.floor(Math.random()*letters.length)];
        const num = (Math.floor(1000 + Math.random()*9000)).toString(); // 1000..9999
        const id = `${letter}-${num}`;
        if (!used.has(id)) {
          saveGeneratedId(id);
          return id;
        }
        attempts++;
      }
      // fallback: короткая временная метка
      return 'Z-' + String(Date.now()).slice(-6);
    }
    // ---------- end generator ----------

    // QR rendering with fallback (Google -> qrserver -> text)
    function renderQR(orderId, personalId) {
      qrContainer.innerHTML = '';
      const payload = `Order:${orderId};Personal:${personalId}`;
      const sizePx = 260;
      const googleUrl = 'https://chart.googleapis.com/chart?cht=qr&chs=' + sizePx + 'x' + sizePx + '&chl=' + encodeURIComponent(payload);
      const qrserverUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=' + sizePx + 'x' + sizePx + '&data=' + encodeURIComponent(payload);

      const img = new Image();
      img.alt = 'QR-код заказа';
      img.title = 'QR-код заказа';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      img.decoding = 'async';

      img.onload = () => { qrContainer.appendChild(img); };
      img.onerror = () => {
        img.onerror = () => {
          qrContainer.textContent = 'QR недоступен';
          qrContainer.style.color = '#666';
          qrContainer.style.fontSize = '13px';
          qrContainer.style.padding = '8px';
        };
        img.src = qrserverUrl;
      };
      img.src = googleUrl;
    }

    // Modal focus trap helpers
    let lastFocused = null;
    function trapFocus(modalEl){
      const focusable = 'a, button, textarea, input, select, [tabindex]:not([tabindex="-1"])';
      const nodes = Array.from(modalEl.querySelectorAll(focusable)).filter(n=>!n.hasAttribute('disabled'));
      if (nodes.length===0) return;
      let idx = 0;
      nodes[0].focus();
      function keyHandler(e){
        if (e.key === 'Tab') {
          e.preventDefault();
          if (e.shiftKey) idx = (idx -1 + nodes.length) % nodes.length;
          else idx = (idx +1) % nodes.length;
          nodes[idx].focus();
        } else if (e.key === 'Escape' || e.key === 'Esc') {
          closeModal();
        }
      }
      modalEl._keyHandler = keyHandler;
      document.addEventListener('keydown', keyHandler);
    }
    function releaseFocus(modalEl){
      if (modalEl && modalEl._keyHandler) {
        document.removeEventListener('keydown', modalEl._keyHandler);
        delete modalEl._keyHandler;
      }
    }

    function showModal(title, msg, orderId, personalId) {
      modalTitle.textContent = title||'Заявка принята';
      modalMsg.textContent = msg||'Спасибо, ваша заявка отправлена.';
      orderIdDisplay.textContent = orderId || '—';
      personalIdDisplay.textContent = personalId || '—';
      try { renderQR(orderId, personalId); } catch(e){ qrContainer.textContent = 'QR недоступен'; }
      modal.setAttribute('aria-hidden','false');
      modal.style.display = 'flex';
      lastFocused = document.activeElement;
      trapFocus(modal);
      document.body.style.overflow = 'hidden';
    }
    function closeModal(){
      modal.setAttribute('aria-hidden','true');
      modal.style.display = 'none';
      releaseFocus(modal);
      if (lastFocused) lastFocused.focus();
      document.body.style.overflow = '';
    }

    // Printable summary
    function openPrintable(orderId, personalId){
      const payload = {
        orderId, personalId,
        name: nameEl.value, phone: phoneEl.value, email: emailEl.value,
        vin: vinEl.value, model: modelEl.value, year: yearEl.value,
        partName: partEl.value, article: articleEl.value, qty: qtyEl.value, comment: commentEl.value
      };
      const html = `
        <html><head><title>Заявка ${orderId}</title>
        <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#071428} h1{font-size:18px} .k{margin:8px 0} .k b{display:inline-block;width:150px}</style></head><body>
        <h1>Заявка №${orderId}</h1>
        ${Object.keys(payload).map(k=>`<div class="k"><b>${k}:</b> ${payload[k] || '—'}</div>`).join('')}
        <p style="margin-top:20px;color:#666">Сгенерировано: ${new Date().toLocaleString()}</p>
        </body></html>`;
      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 500);
    }

    // Copy / download / close handlers
    copyBtn.addEventListener('click', () => {
      const text = `Order ID: ${orderIdDisplay.textContent}, Personal ID: ${personalIdDisplay.textContent}`;
      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(text).then(()=> alert('Скопировано: ' + text)).catch(()=> prompt('Скопируйте вручную:', text));
      } else { prompt('Скопируйте вручную:', text); }
    });
    downloadPdfBtn.addEventListener('click', () => openPrintable(orderIdDisplay.textContent, personalIdDisplay.textContent));
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (ev) => { if (ev.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

    // Wiring inputs: mask, autosave, live checks
    phoneEl.addEventListener('input', () => { phoneEl.value = formatPhone(phoneEl.value); scheduleAutosave(); });
    nameEl.addEventListener('input', () => {
      const v = nameEl.value;
      if (isLikelyLatinGibberish(v)) showError(nameError, 'Пожалуйста, введите ФИО кириллицей (не используйте латиницу).');
      else showError(nameError, '');
      scheduleAutosave();
    });
    [emailEl, vinEl, modelEl, yearEl, partEl, articleEl, qtyEl, commentEl].forEach(el => { if (!el) return; el.addEventListener('input', scheduleAutosave); });
    consentEl.addEventListener('change', scheduleAutosave);

    loadDraftIfAny();

    // Blur validation
    nameEl.addEventListener('blur', ()=>{ const r = validateName(); showError(nameError, r.ok ? '' : r.msg); });
    phoneEl.addEventListener('blur', ()=>{ const r = validatePhone(); showError(phoneError, r.ok ? '' : r.msg); });
    emailEl.addEventListener('blur', ()=>{ const r = validateEmail(); showError(emailError, r.ok ? '' : r.msg); });
    vinEl.addEventListener('blur', ()=>{ const r = validateVIN(); showError(vinError, r.ok ? '' : r.msg); });
    partEl.addEventListener('blur', ()=>{ const r = validatePart(); showError(partError, r.ok ? '' : r.msg); });

    // Validate all before submit
    function validateAll(){
      let ok = true;

      if (isLikelyLatinGibberish(nameEl.value)) { showError(nameError, 'ФИО должно быть кириллицей, не используйте латиницу.'); ok=false; }
      else { const r = validateName(); if (!r.ok){ showError(nameError, r.msg); ok=false; } else showError(nameError,''); }

      const ph = validatePhone(); if (!ph.ok){ showError(phoneError, ph.msg); ok=false; } else showError(phoneError,'');
      const em = validateEmail(); if (!em.ok){ showError(emailError, em.msg); ok=false; } else showError(emailError,'');
      const vr = validateVIN(); if (!vr.ok){ showError(vinError, vr.msg); ok=false; } else showError(vinError,'');
      const pr = validatePart(); if (!pr.ok){ showError(partError, pr.msg); ok=false; } else showError(partError,'');

      if (!consentEl.checked) { showError(consentError, 'Для отправки формы необходимо ваше согласие.'); ok=false; } else showError(consentError,'');

      return ok;
    }

    // Submit handler
    form.addEventListener('submit', (ev) => {
      ev.preventDefault();
      if (!validateAll()) return;

      // <-- here: generate short readable order id instead of Date.now()
      const orderId = generateShortOrderId();
      const phoneDigits = (phoneEl.value||'').replace(/\D/g,'');
      const personalId = phoneDigits ? phoneDigits.slice(-4) : '';

      orderIdInput.value = orderId;
      personalIdInput.value = personalId;
      form.dataset.orderId = orderId;
      form.dataset.personalId = personalId;

      submitBtn.disabled = true;
      btnText.innerHTML = '<span class="spinner" aria-hidden="true"></span> Отправляется...';
      submitBtn.setAttribute('aria-busy','true');

      let fallback = setTimeout(()=> {
        submitBtn.disabled = false;
        btnText.textContent = 'Отправить заявку';
        successBanner.style.display = 'block';
        showModal('Заявка принята', 'Спасибо, ваша заявка отправлена.', orderId, personalId);
        try { localStorage.removeItem('orderFormDraft'); } catch(e){}
      }, 10000);

      function onIframeLoad(){
        clearTimeout(fallback);
        submitBtn.disabled = false;
        btnText.textContent = 'Отправить заявку';
        successBanner.style.display = 'block';
        showModal('Заявка принята', 'Спасибо, ваша заявка отправлена. Проверьте таблицу/почту.', orderId, personalId);
        try { localStorage.removeItem('orderFormDraft'); } catch(e){}
        iframe.removeEventListener('load', onIframeLoad);
      }
      if (iframe) iframe.addEventListener('load', onIframeLoad, { once: true });

      // native submit to iframe
      form.submit();
    });

  }); // DOMContentLoaded end
  </script>
</body>
</html>
