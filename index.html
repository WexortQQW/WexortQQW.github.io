<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Форма заказа запчастей</title>
  <style>
    /* минимальный стиль для примера */
    body{font-family:system-ui,Arial; background:#f5f7fa; margin:0; padding:20px; display:flex;justify-content:center}
    .card{width:720px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08)}
    label{display:block;margin:8px 0}
    input,textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd}
    button{background:#2563eb;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45)}
    .modal .box{background:#fff;padding:18px;border-radius:10px;min-width:320px;text-align:center}
    .ids{display:flex;gap:12px;justify-content:center;margin:12px 0}
    .id{padding:10px 12px;border-radius:8px;background:#f3f4f6}
    #status{margin-left:12px;color:#666}
  </style>
</head>
<body>
  <div class="card">
    <h2>Форма заказа запчастей</h2>

    <!-- !!! ЗАМЕНИ GAS_URL на твой Web App URL (включая /exec) !!! -->
    <script>const GAS_URL = "https://script.google.com/macros/s/AKfycbyGrlxlTeOs2mTtgCL5gQ9dsAe6T2rHr1WZPWdytdy3xG6__EItqJjXX8iqVURV5PukUQ/exec";</script>

    <form id="orderForm" method="POST" action="" target="hidden_iframe" onsubmit="return handleSubmit(event)">
      <!-- form fields -->
      <label>ФИО* <input name="фио" required></label>
      <label>Телефон* <input name="телефон" required autocomplete="tel"></label>
      <label>Email <input name="почта" type="email" autocomplete="email"></label>
      <label>VIN* <input name="вин" pattern="[A-HJ-NPR-Z0-9]{17}" required></label>
      <label>Модель <input name="модель"></label>
      <label>Год <input type="number" name="год" min="1950" max="2099"></label>
      <label>Название детали* <input name="деталь" required></label>
      <label>Артикул <input name="артикул"></label>
      <label>Количество <input type="number" name="количество" min="1" value="1" required></label>
      <label>Коммент <textarea name="комментарии"></textarea></label>

      <div style="display:flex;align-items:center;margin-top:12px">
        <button id="submitBtn" type="submit">Отправить</button>
        <div id="status"></div>
      </div>
    </form>

    <iframe id="hidden_iframe" name="hidden_iframe" style="display:none"></iframe>
  </div>

  <!-- Модалка -->
  <div class="modal" id="modal">
    <div class="box">
      <h3>Заявка принята</h3>
      <p id="modalMsg">...</p>
      <div class="ids">
        <div class="id"><strong>Order ID</strong><div id="orderId">—</div></div>
        <div class="id"><strong>Personal ID</strong><div id="personalId">—</div></div>
      </div>
      <div style="margin-top:8px">
        <button onclick="copyIds()">Копировать</button>
        <button onclick="closeModal()">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    // TRUSTED_ORIGIN должен совпадать с CONFIG.ALLOWED_ORIGIN в GAS
    const TRUSTED_ORIGIN = location.origin; // оставь так, если ALLOWED_ORIGIN = текущий origin

    // Устанавливаем форму action по runtime (чтобы случайно не оставлять placeholder)
    document.getElementById('orderForm').action = GAS_URL;

    // простая проверка: если пользователь забыл заменить GAS_URL — покажем подсказку
    if (!GAS_URL || GAS_URL.indexOf('YOUR_GAS_WEBAPP_ID') !== -1) {
      console.warn('GAS_URL не установлен в index.html. Замените его на Web App URL из GAS (Deploy -> Web app).');
      document.getElementById('status').textContent = 'Ошибка: замените GAS_URL в index.html на ваш Web App URL.';
    }

    function handleSubmit(e) {
      document.getElementById('submitBtn').disabled = true;
      document.getElementById('submitBtn').textContent = 'Отправка...';
      document.getElementById('status').textContent = '';
      // резервный таймаут
      setTimeout(()=> {
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('submitBtn').textContent = 'Отправить';
        showModal('Резерв: заявка отправлена. Проверьте таблицу/почту.');
      }, 12000);
      return true; // продолжить submit в iframe
    }

    // слушаем postMessage от GAS (HtmlOutput in GAS делает window.parent.postMessage(...))
    window.addEventListener('message', function(ev) {
      console.log('postMessage raw:', ev.origin, ev.data);
      if (ev.origin !== TRUSTED_ORIGIN) {
        console.warn('Ignored message from origin', ev.origin);
        return;
      }
      const data = ev.data || {};
      document.getElementById('submitBtn').disabled = false;
      document.getElementById('submitBtn').textContent = 'Отправить';
      if (data.success) {
        document.getElementById('orderId').textContent = data.orderId || '—';
        document.getElementById('personalId').textContent = data.personalId || '—';
        showModal('Спасибо! Ваши идентификаторы:');
        document.getElementById('orderForm').reset();
        document.getElementById('status').textContent = 'Заказ принят.';
      } else {
        document.getElementById('status').textContent = 'Ошибка: ' + (data.error || 'сервер');
        showModal('Ошибка при отправке: ' + (data.error || 'сервер'));
      }
    }, false);

    function showModal(msg) {
      document.getElementById('modalMsg').textContent = msg;
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function copyIds() {
      const text = `Order ID: ${document.getElementById('orderId').textContent}\nPersonal ID: ${document.getElementById('personalId').textContent}`;
      navigator.clipboard && navigator.clipboard.writeText(text).then(()=> alert('Скопировано'));
    }
  </script>
</body>
</html>
